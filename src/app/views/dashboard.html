<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <base href="/fileforge/">
    <title>Dashboard - FileForge</title>
    <link rel="stylesheet" href="app/public/css/dashboard.css">
    <!-- ... (rest of stylesheets same as before) ... -->
    <link rel="stylesheet" href="app/public/css/start.css">
    <link rel="stylesheet" href="app/public/css/download.css">
    <link rel="stylesheet" href="app/public/css/convert.css">
    <link rel="stylesheet" href="app/public/css/cloud/layout.css">
    <link rel="stylesheet" href="app/public/css/cloud/explorer.css">
    <link rel="stylesheet" href="app/public/css/cloud/modals.css">
    <link rel="stylesheet" href="app/public/css/cloud/upload.css">
    <link rel="stylesheet" href="app/public/css/settings.css">
    <link rel="stylesheet" href="app/public/css/notifications.css">
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;500;600;700&display=swap" rel="stylesheet">
</head>

<body>
    <nav id="app-sidebar" class="app-sidebar"></nav>

    <div id="global-notifications-container"></div>

    <div id="page-content" class="main-container">
        <!-- Content will be loaded here -->
    </div>

    <!-- Modals (Danger Zone, etc.) remain here as in previous version -->
    <div id="delete-confirm-modal" class="modal-overlay">
        <div class="modal">
            <div class="warning-icon"></div>
            <h3>Danger Zone</h3>
            <p>Please select an action. <br><strong>Warning: These actions are irreversible.</strong></p>

            <div class="danger-options">
                <label class="danger-option">
                    <input type="radio" name="danger-action" value="clear-db">
                    <div class="danger-option-text">
                        <span class="danger-option-title">Clear Database Only</span>
                        <span class="danger-option-desc">Removes files from app, keeps them in Telegram.</span>
                    </div>
                </label>

                <label class="danger-option">
                    <input type="radio" name="danger-action" value="delete-account">
                    <div class="danger-option-text">
                        <span class="danger-option-title">Delete Account</span>
                        <span class="danger-option-desc">Deletes account & DB. Telegram channel stays untouched.</span>
                    </div>
                </label>
            </div>

            <button id="confirm-danger-btn" disabled>Confirm Action</button>
        </div>
    </div>

    <div id="other-platform-modal" class="modal-overlay">
        <div class="modal">
            <h3>Unsupported Platform</h3>
            <p>Downloads from "Other" platforms may not work as expected. Please proceed only if you know what you are
                doing.</p>
            <button id="other-platform-ok" class="wizard-btn btn-next">I understand, continue</button>
        </div>
    </div>

    <div id="format-required-modal" class="modal-overlay">
        <div class="modal">
            <h3>Format Required</h3>
            <p>Please choose a format like MP3 or MP4 before starting the download.</p>
            <button id="format-required-ok" class="modal-ok-btn">OK</button>
        </div>
    </div>

    <script src="app/public/js/notifications.js"></script>

    <script>
        document.addEventListener('DOMContentLoaded', () => {
            const navContainer = document.getElementById('app-sidebar');
            const pageContent = document.getElementById('page-content');
            let navLinks = [];
            let currentUsername = '';

            const pageConfig = {
                'start': { url: 'app/page/start.html', js: 'app/public/js/start.js' },
                'download': { url: 'app/page/download.html', js: 'app/public/js/download.js' },
                'convert': { url: 'app/page/convert.html' },
                'cloud': { url: 'app/page/cloud.html', js: 'app/public/js/cloud/cloud.js', type: 'module' },
                'settings': { url: 'app/page/settings.html', js: 'app/public/js/settings.js' },
            };

            const handleLogout = () => {
                fetch('api/auth/logout', { method: 'POST' })
                    .then(response => { if (response.ok) window.location.href = 'login'; })
                    .catch(error => console.error('Logout failed:', error));
            };

            const updateNavIndicator = (activeLink) => {
                const indicator = document.getElementById('nav-active-indicator');
                if (!indicator) return;

                if (!activeLink || !activeLink.closest('.nav-links')) {
                    indicator.style.opacity = '0';
                    return;
                }

                const linkRect = activeLink.getBoundingClientRect();
                const navRect = activeLink.closest('.nav-links').getBoundingClientRect();

                indicator.style.opacity = '1';
                indicator.style.width = `${linkRect.width}px`;
                indicator.style.height = `${linkRect.height}px`;
                indicator.style.left = `${linkRect.left - navRect.left}px`;
                indicator.style.top = `${linkRect.top - navRect.top}px`;
            };

            const loadPage = async (pageName) => {
                const config = pageConfig[pageName];
                if (!config) return loadPage('start');

                try {
                    pageContent.classList.add('fade-out');
                    await new Promise(resolve => setTimeout(resolve, 200));

                    const oldScript = document.querySelector('script[data-page-script]');
                    if (oldScript) oldScript.remove();

                    const response = await fetch(config.url);
                    if (!response.ok) throw new Error('Failed to load page content.');

                    pageContent.innerHTML = await response.text();
                    pageContent.classList.remove('fade-out');

                    if (config.js) {
                        const script = document.createElement('script');
                        script.src = `${config.js}?t=${Date.now()}`;
                        if (config.type) {
                            script.type = config.type;
                        }
                        script.dataset.pageScript = 'true';
                        document.body.appendChild(script);
                    }

                    navLinks.forEach(link => link.classList.toggle('active', link.dataset.page === pageName));
                    setTimeout(() => updateNavIndicator(document.querySelector('.nav-link.active')), 50);

                } catch (error) { console.error('Error loading page:', error); }
            };

            const setupNavigation = () => {
                navLinks = document.querySelectorAll('.nav-link');
                const profileMenu = document.getElementById('profile-menu');
                const profileBtns = [
                    document.getElementById('profile-btn'),
                    document.getElementById('desktop-profile-btn')
                ];

                navLinks.forEach(link => {
                    link.addEventListener('click', (e) => {
                        e.preventDefault();

                        // Icon Animation Logic
                        const svgs = link.querySelectorAll('svg');
                        const page = link.dataset.page;
                        let animClass = '';

                        if (page === 'cloud') animClass = 'anim-fly-cloud';
                        else if (page === 'convert') animClass = 'anim-spin-convert';
                        else if (page === 'download') animClass = 'anim-bounce-download';
                        else if (page === 'start') animClass = 'anim-pulse-start';

                        if (animClass) {
                            svgs.forEach(svg => {
                                svg.classList.remove(animClass);
                                void svg.offsetWidth; // Force reflow
                                svg.classList.add(animClass);

                                // Clean up after animation
                                svg.addEventListener('animationend', () => {
                                    svg.classList.remove(animClass);
                                }, { once: true });
                            });
                        }

                        // Navigation Logic
                        const pageName = link.dataset.page;
                        if (pageName && !link.classList.contains('active')) {
                            loadPage(pageName);
                        }
                        profileMenu.classList.remove('show');
                    });
                });

                profileBtns.forEach(btn => {
                    if (btn) btn.addEventListener('click', (e) => {
                        e.preventDefault(); e.stopPropagation();
                        profileMenu.classList.toggle('show');
                    });
                });

                document.getElementById('menu-logout-btn')?.addEventListener('click', handleLogout);
                document.querySelector('.delete-link')?.addEventListener('click', (e) => {
                    e.preventDefault();
                    profileMenu.classList.remove('show');
                    openDangerModal();
                });

                window.addEventListener('resize', () => {
                    const activeLink = document.querySelector('.nav-link.active');
                    if (activeLink) updateNavIndicator(activeLink);
                });

                document.addEventListener('fullscreenchange', () => {
                    setTimeout(() => {
                        const activeLink = document.querySelector('.nav-link.active');
                        if (activeLink) updateNavIndicator(activeLink);
                    }, 200);
                });
            };

            window.updateNavIndicator = updateNavIndicator;

            const setupModals = () => {
                const dangerModal = document.getElementById('delete-confirm-modal');
                const confirmBtn = document.getElementById('confirm-danger-btn');
                const radioButtons = document.querySelectorAll('input[name="danger-action"]');

                radioButtons.forEach(radio => {
                    radio.addEventListener('change', () => {
                        confirmBtn.disabled = false;
                        confirmBtn.textContent = 'Confirm Action';
                    });
                });

                dangerModal.addEventListener('click', (e) => {
                    if (e.target === dangerModal) {
                        dangerModal.classList.remove('visible');
                        radioButtons.forEach(r => r.checked = false);
                        confirmBtn.disabled = true;
                    }
                });

                confirmBtn.addEventListener('click', async () => {
                    const selected = document.querySelector('input[name="danger-action"]:checked');
                    if (!selected) return;

                    const action = selected.value;
                    confirmBtn.disabled = true;
                    confirmBtn.textContent = 'Processing...';

                    await handleDangerAction(action, dangerModal);
                });

                const otherPlatformModal = document.getElementById('other-platform-modal');
                otherPlatformModal.addEventListener('click', (e) => {
                    if (e.target === otherPlatformModal || e.target.id === 'other-platform-ok') {
                        otherPlatformModal.classList.remove('visible');
                    }
                });

                const formatModal = document.getElementById('format-required-modal');
                formatModal.addEventListener('click', (e) => {
                    if (e.target === formatModal || e.target.id === 'format-required-ok') {
                        formatModal.classList.remove('visible');
                    }
                });
            };

            const handleDangerAction = async (action, modal) => {
                try {
                    if (action === 'clear-db') {
                        const res = await fetch('api/cloud/maintenance/db', { method: 'DELETE' });
                        if (res.ok) {
                            window.NotificationManager.showNotification('success', 'Database Cleared', 'All database entries have been removed.');
                            modal.classList.remove('visible');
                            if (document.querySelector('.nav-link[data-page="cloud"]').classList.contains('active')) {
                                loadPage('cloud');
                            }
                        } else throw new Error('Failed to clear DB');

                    } else if (action === 'delete-account') {
                        const res = await fetch('api/user/delete', { method: 'DELETE' });
                        if (res.ok) {
                            window.location.href = '.';
                        } else throw new Error('Failed to delete account');
                    }
                } catch (error) {
                    console.error('Danger Action Failed:', error);
                    window.NotificationManager.showNotification('error', 'Action Failed', error.message || 'Something went wrong.');
                    modal.classList.remove('visible');
                }
            };

            const openDangerModal = () => {
                const modal = document.getElementById('delete-confirm-modal');
                document.querySelectorAll('input[name="danger-action"]').forEach(r => r.checked = false);
                const btn = document.getElementById('confirm-danger-btn');
                btn.disabled = true;
                btn.textContent = 'Confirm Action';
                modal.classList.add('visible');
            };

            const fetchUserInfo = async () => {
                try {
                    const response = await fetch('api/user/info');
                    const data = await response.json();

                    // APPLY THEME HERE
                    if (data.colormode === 'white') {
                        document.body.classList.add('light-theme');
                    } else {
                        document.body.classList.remove('light-theme');
                    }

                    currentUsername = data.username;
                    const profileIcons = document.querySelectorAll('.profile-icon');
                    if (profileIcons.length && currentUsername) {
                        const initial = currentUsername.charAt(0).toUpperCase();
                        profileIcons.forEach(icon => icon.textContent = initial);
                    }
                } catch (error) { console.error('Failed to fetch user info', error); }
            };

            fetch('app/modules/d_nav.html')
                .then(response => response.text())
                .then(async data => {
                    navContainer.innerHTML = data;
                    setupNavigation();
                    setupModals();
                    await fetchUserInfo();
                    loadPage('start');
                })
                .catch(error => console.error('Error loading navigation:', error));
        });
    </script>
</body>

</html>