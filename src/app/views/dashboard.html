<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Dashboard - FileForge</title>
    <link rel="stylesheet" href="/app/public/css/dashboard.css">
    <link rel="stylesheet" href="/app/public/css/start.css">
    <link rel="stylesheet" href="/app/public/css/download.css">
    <link rel="stylesheet" href="/app/public/css/convert.css">
    <link rel="stylesheet" href="/app/public/css/sharing.css">
    <link rel="stylesheet" href="/app/public/css/settings.css">
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;500;600;700&display=swap" rel="stylesheet">
</head>
<body>
    <nav id="app-sidebar" class="app-sidebar"></nav>

    <div id="page-content" class="main-container">
        <!-- Content will be loaded here by JavaScript -->
    </div>
    
    <script>
        document.addEventListener('DOMContentLoaded', () => {
            const navContainer = document.getElementById('app-sidebar');
            const pageContent = document.getElementById('page-content');
            let navLinks = [];

            const pageConfig = {
                'start': { url: '/app/page/start.html' },
                'download': { url: '/app/page/download.html' },
                'convert': { url: '/app/page/convert.html' },
                'sharing': { url: '/app/page/sharing.html' },
                'settings': { url: '/app/page/settings.html' },
            };

            const handleLogout = () => {
                fetch('/api/auth/logout', { method: 'POST' })
                    .then(response => {
                        if (response.ok) window.location.href = '/login';
                    })
                    .catch(error => console.error('Logout failed:', error));
            };

            const loadPage = async (pageName, isPopState = false) => {
                const config = pageConfig[pageName];
                if (!config) return loadPage('start');

                try {
                    pageContent.classList.add('fade-out');
                    await new Promise(resolve => setTimeout(resolve, 200));

                    const response = await fetch(config.url);
                    if (!response.ok) throw new Error('Failed to load page content.');
                    
                    pageContent.innerHTML = await response.text();
                    
                    const logoutBtn = pageContent.querySelector('#logoutBtn');
                    if (logoutBtn) logoutBtn.addEventListener('click', handleLogout);
                    
                    pageContent.classList.remove('fade-out');

                    navLinks.forEach(link => link.classList.toggle('active', link.dataset.page === pageName));

                } catch (error) {
                    console.error('Error loading page:', error);
                    pageContent.innerHTML = `<h1>Error</h1><p>Could not load page content.</p>`;
                }
            };

            const setupNavigation = () => {
                navLinks = document.querySelectorAll('.nav-link');
                const profileBtn = document.getElementById('profile-btn');
                const profileMenu = document.getElementById('profile-menu');

                navLinks.forEach(link => {
                    link.addEventListener('click', (e) => {
                        e.preventDefault();
                        const pageName = link.dataset.page;
                        if (!link.classList.contains('active')) {
                            loadPage(pageName);
                        }
                        profileMenu.classList.remove('show');
                    });
                });

                if (profileBtn) {
                    profileBtn.addEventListener('click', (e) => {
                        e.preventDefault();
                        e.stopPropagation();
                        profileMenu.classList.toggle('show');
                    });
                }
                
                document.getElementById('menu-logout-btn')?.addEventListener('click', handleLogout);

                window.addEventListener('click', (e) => {
                    if (profileMenu && !profileMenu.contains(e.target) && !profileBtn.contains(e.target)) {
                        profileMenu.classList.remove('show');
                    }
                });
            };

            const fetchUserInfo = async () => {
                try {
                    const response = await fetch('/api/user/info');
                    const data = await response.json();
                    const profileIcon = document.querySelector('.profile-icon');
                    if (profileIcon && data.username) {
                        profileIcon.textContent = data.username.charAt(0).toUpperCase();
                    }
                } catch (error) {
                    console.error('Failed to fetch user info', error);
                }
            };

            fetch('/app/modules/d_nav.html')
                .then(response => response.text())
                .then(async data => {
                    navContainer.innerHTML = data;
                    setupNavigation();
                    await fetchUserInfo();
                    loadPage('start'); 
                })
                .catch(error => console.error('Error loading navigation:', error));
        });
    </script>
</body>
</html>