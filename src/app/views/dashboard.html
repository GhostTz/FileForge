<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Dashboard - FileForge</title>
    <link rel="stylesheet" href="/app/public/css/dashboard.css">
    <link rel="stylesheet" href="/app/public/css/start.css">
    <link rel="stylesheet" href="/app/public/css/download.css">
    <link rel="stylesheet" href="/app/public/css/convert.css">
    <link rel="stylesheet" href="/app/public/css/cloud.css">
    <link rel="stylesheet" href="/app/public/css/settings.css">
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;500;600;700&display=swap" rel="stylesheet">
</head>
<body>
    <nav id="app-sidebar" class="app-sidebar"></nav>

    <div id="page-content" class="main-container">
        <!-- Content will be loaded here by JavaScript -->
    </div>

    <div id="delete-confirm-modal" class="modal-overlay">
        <div class="modal">
            <div class="warning-icon"></div>
            <h3>Delete Account</h3>
            <p>This action is permanent and cannot be reverted. Are you absolutely sure?</p>
            <div class="confirm-delete-group">
                <label for="confirm-delete-checkbox">
                    <input type="checkbox" id="confirm-delete-checkbox">
                    <span class="checkbox"></span>
                    <span>I'm sure I want to delete the account <strong id="delete-username"></strong>.</span>
                </label>
            </div>
            <button id="delete-account-btn" class="danger-btn" disabled>Delete Account</button>
        </div>
    </div>

    <div id="other-platform-modal" class="modal-overlay">
        <div class="modal">
             <h3>Unsupported Platform</h3>
             <p>Downloads from "Other" platforms may not work as expected. Please proceed only if you know what you are doing.</p>
             <button id="other-platform-ok" class="wizard-btn btn-next">I understand, continue</button>
        </div>
    </div>

    <div id="format-required-modal" class="modal-overlay">
        <div class="modal">
             <h3>Format Required</h3>
             <p>Please choose a format like MP3 or MP4 before starting the download.</p>
             <button id="format-required-ok" class="modal-ok-btn">OK</button>
        </div>
    </div>
    
    <script>
        document.addEventListener('DOMContentLoaded', () => {
            const navContainer = document.getElementById('app-sidebar');
            const pageContent = document.getElementById('page-content');
            let navLinks = [];
            let currentUsername = '';

            const pageConfig = {
                'start': { url: '/app/page/start.html' },
                'download': { url: '/app/page/download.html', js: '/app/public/js/download.js' },
                'convert': { url: '/app/page/convert.html' },
                'cloud': { url: '/app/page/cloud.html', js: '/app/public/js/cloud.js' },
                'settings': { url: '/app/page/settings.html' },
            };

            const handleLogout = () => {
                fetch('/api/auth/logout', { method: 'POST' })
                    .then(response => { if (response.ok) window.location.href = '/login'; })
                    .catch(error => console.error('Logout failed:', error));
            };

            const updateNavIndicator = (activeLink) => {
                const indicator = document.getElementById('nav-active-indicator');
                if (!indicator || !activeLink) return;

                const linkRect = activeLink.getBoundingClientRect();
                const navRect = activeLink.closest('.nav-links').getBoundingClientRect();

                indicator.style.width = `${linkRect.width}px`;
                indicator.style.height = `${linkRect.height}px`;
                indicator.style.left = `${linkRect.left - navRect.left}px`;
                indicator.style.top = `${linkRect.top - navRect.top}px`;
            };

            const loadPage = async (pageName) => {
                const config = pageConfig[pageName];
                if (!config) return loadPage('start');

                try {
                    pageContent.classList.add('fade-out');
                    await new Promise(resolve => setTimeout(resolve, 200));
                    const response = await fetch(config.url);
                    if (!response.ok) throw new Error('Failed to load page content.');
                    
                    pageContent.innerHTML = await response.text();
                    pageContent.classList.remove('fade-out');

                    // If there's a script associated with the page, load it
                    if (config.js) {
                        // Remove previous script if it exists
                        const oldScript = document.querySelector('script[data-page-script]');
                        if(oldScript) oldScript.remove();
                        
                        const script = document.createElement('script');
                        script.src = config.js;
                        script.dataset.pageScript = 'true'; // Mark the script
                        script.onload = () => script.remove(); // Clean up script tag after execution
                        document.body.appendChild(script);
                    }

                    navLinks.forEach(link => link.classList.toggle('active', link.dataset.page === pageName));
                    setTimeout(() => updateNavIndicator(document.querySelector('.nav-link.active')), 50);

                } catch (error) { console.error('Error loading page:', error); }
            };

            const setupNavigation = () => {
                navLinks = document.querySelectorAll('.nav-link');
                const profileMenu = document.getElementById('profile-menu');
                
                const profileBtns = [
                    document.getElementById('profile-btn'),
                    document.getElementById('desktop-profile-btn')
                ];

                navLinks.forEach(link => {
                    link.addEventListener('click', (e) => {
                        e.preventDefault();
                        const pageName = link.dataset.page;
                        if (pageName && !link.classList.contains('active')) {
                            loadPage(pageName);
                        }
                        profileMenu.classList.remove('show');
                    });
                });
                
                profileBtns.forEach(btn => {
                    if(btn) btn.addEventListener('click', (e) => {
                        e.preventDefault(); e.stopPropagation();
                        profileMenu.classList.toggle('show');
                    });
                });
                
                document.getElementById('menu-logout-btn')?.addEventListener('click', handleLogout);
                document.querySelector('.delete-link')?.addEventListener('click', (e) => {
                    e.preventDefault();
                    profileMenu.classList.remove('show');
                    openDeleteModal();
                });

                window.addEventListener('click', () => profileMenu.classList.remove('show'));
                window.addEventListener('resize', () => updateNavIndicator(document.querySelector('.nav-link.active')));
            };
            
            const setupModals = () => {
                const deleteModal = document.getElementById('delete-confirm-modal');
                const checkbox = document.getElementById('confirm-delete-checkbox');
                const deleteBtn = document.getElementById('delete-account-btn');

                checkbox.addEventListener('change', () => { deleteBtn.disabled = !checkbox.checked; });
                deleteModal.addEventListener('click', (e) => { if (e.target === deleteModal) deleteModal.classList.remove('visible'); });
                deleteBtn.addEventListener('click', async () => {
                    try {
                        const response = await fetch('/api/user/delete', { method: 'DELETE' });
                        if(response.ok) { window.location.href = '/'; }
                    } catch (error) { console.error('Error during account deletion:', error); }
                });

                const otherPlatformModal = document.getElementById('other-platform-modal');
                otherPlatformModal.addEventListener('click', (e) => {
                    if (e.target === otherPlatformModal || e.target.id === 'other-platform-ok') {
                        otherPlatformModal.classList.remove('visible');
                    }
                });

                const formatModal = document.getElementById('format-required-modal');
                formatModal.addEventListener('click', (e) => {
                    if (e.target === formatModal || e.target.id === 'format-required-ok') {
                        formatModal.classList.remove('visible');
                    }
                });
            };

            const openDeleteModal = () => {
                const modal = document.getElementById('delete-confirm-modal');
                document.getElementById('delete-username').textContent = currentUsername;
                document.getElementById('confirm-delete-checkbox').checked = false;
                document.getElementById('delete-account-btn').disabled = true;
                modal.classList.add('visible');
            };

            const fetchUserInfo = async () => {
                try {
                    const response = await fetch('/api/user/info');
                    const data = await response.json();
                    currentUsername = data.username;
                    const profileIcons = document.querySelectorAll('.profile-icon');
                    if (profileIcons.length && currentUsername) {
                        const initial = currentUsername.charAt(0).toUpperCase();
                        profileIcons.forEach(icon => icon.textContent = initial);
                    }
                } catch (error) { console.error('Failed to fetch user info', error); }
            };

            fetch('/app/modules/d_nav.html')
                .then(response => response.text())
                .then(async data => {
                    navContainer.innerHTML = data;
                    setupNavigation();
                    setupModals();
                    await fetchUserInfo();
                    loadPage('start'); 
                })
                .catch(error => console.error('Error loading navigation:', error));
        });
    </script>
</body>
</html>